{% extends 'monitor/base.html' %}
{% load static %}

{% block content %}
<h2 class="mb-4" style="color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <i class="fas fa-history me-2"></i>日志中心
</h2>

<div class="row">
    <!-- 项目日志区域 -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-server me-2" style="color: #17a2b8;"></i>项目日志
                <div class="float-end">
                    <small class="text-muted">
                        <i class="fas fa-circle text-success me-1"></i>实时监控
                    </small>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="project-log-container" style="height: 500px; overflow-y: auto; background-color: #1a1a1a; color: #00ff00; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.9em; padding: 10px;">
                    <div id="projectLogContent">
                        <!-- 日志内容将通过SSE动态添加 -->
                        <div class="text-center text-muted" style="color: #666;">
                            <i class="fas fa-spinner fa-spin me-2"></i>正在连接日志流...
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="row text-center">
                    <div class="col-4">
                        <button class="btn btn-sm btn-outline-info" onclick="clearProjectLogs()">
                            <i class="fas fa-trash me-1"></i>清空
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-sm btn-outline-success" onclick="toggleAutoScroll()">
                            <i class="fas fa-play me-1"></i>
                            <span id="scrollStatus">滚动</span>
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-sm btn-outline-primary" onclick="exportProjectLogs()">
                            <i class="fas fa-download me-1"></i>导出
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 导入日志区域 -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-file-import me-2" style="color: #28a745;"></i>导入日志
                <div class="float-end">
                    <small class="text-muted">共 {{ import_logs_count }} 条记录</small>
                </div>
            </div>
            <div class="card-body p-0">
                <!-- 筛选器 -->
                <div class="p-3 border-bottom">
                    <form method="get" class="row g-2">
                        <div class="col-md-6">
                            <label for="type" class="form-label small">日志类型</label>
                            <select class="form-select form-select-sm" id="type" name="type">
                                <option value="">全部类型</option>
                                <option value="bird" {% if log_type == 'bird' %}selected{% endif %}>鸟情数据</option>
                                <option value="airport" {% if log_type == 'airport' %}selected{% endif %}>机场数据</option>
                                <option value="geodata" {% if log_type == 'geodata' %}selected{% endif %}>地理数据</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="status" class="form-label small">状态</label>
                            <select class="form-select form-select-sm" id="status" name="status">
                                <option value="">全部状态</option>
                                <option value="completed" {% if status == 'completed' %}selected{% endif %}>成功</option>
                                <option value="completed_with_errors" {% if status == 'completed_with_errors' %}selected{% endif %}>部分成功</option>
                                <option value="failed" {% if status == 'failed' %}selected{% endif %}>失败</option>
                                <option value="processing" {% if status == 'processing' %}selected{% endif %}>处理中</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary btn-sm me-2">
                                <i class="fas fa-filter me-1"></i>筛选
                            </button>
                            <a href="{% url 'logs' %}" class="btn btn-secondary btn-sm">
                                <i class="fas fa-times me-1"></i>清除筛选
                            </a>
                        </div>
                    </form>
                </div>

                <!-- 导入日志列表 -->
                <div class="import-log-container" style="height: 400px; overflow-y: auto;">
                    {% if page_obj %}
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 120px;">时间</th>
                                    <th style="width: 80px;">类型</th>
                                    <th>文件名</th>
                                    <th style="width: 60px;">状态</th>
                                    <th style="width: 100px;">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in page_obj %}
                                <tr class="clickable-row" onclick="viewImportLog({{ log.id }})" style="cursor: pointer;">
                                    <td>
                                        <div class="small">{{ log.created_at|date:"m-d H:i" }}</div>
                                    </td>
                                    <td>
                                        {% if log.log_type == 'bird' %}
                                            <span class="badge bg-info">鸟情</span>
                                        {% elif log.log_type == 'airport' %}
                                            <span class="badge bg-primary">机场</span>
                                        {% elif log.log_type == 'geodata' %}
                                            <span class="badge bg-success">地理</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ log.log_type }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="text-truncate small" style="max-width: 150px;" title="{{ log.file_name }}">
                                            {{ log.file_name }}
                                        </div>
                                    </td>
                                    <td>
                                        {% if log.status == 'completed' %}
                                            <span class="badge bg-success">成功</span>
                                        {% elif log.status == 'completed_with_errors' %}
                                            <span class="badge bg-warning text-dark">部分</span>
                                        {% elif log.status == 'failed' %}
                                            <span class="badge bg-danger">失败</span>
                                        {% elif log.status == 'processing' %}
                                            <span class="badge bg-info">处理中</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ log.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-success btn-sm" onclick="event.stopPropagation(); openRealtimeLog({{ log.id }})" title="实时日志">
                                                <i class="fas fa-terminal"></i>
                                            </button>
                                            <button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); viewImportLogDetail({{ log.id }})" title="详情">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-2x mb-2"></i>
                                        <br>暂无导入日志记录
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- 简化的分页 -->
                    {% if page_obj.has_other_pages %}
                    <div class="p-2 border-top">
                        <nav aria-label="日志分页">
                            <ul class="pagination pagination-sm justify-content-center mb-0">
                                {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% if log_type %}type={{ log_type }}&{% endif %}{% if status %}status={{ status }}&{% endif %}page={{ page_obj.previous_page_number }}">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                </li>
                                {% endif %}

                                <li class="page-item active">
                                    <span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
                                </li>

                                {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% if log_type %}type={{ log_type }}&{% endif %}{% if status %}status={{ status }}&{% endif %}page={{ page_obj.next_page_number }}">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}

                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-history fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">暂无导入日志</h6>
                        <p class="text-muted small">当您进行数据导入时，日志记录将显示在这里</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 导入日志详情模态框 -->
<div class="modal fade" id="importLogDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">导入日志详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="importLogDetailContent">
                <!-- 动态内容 -->
            </div>
        </div>
    </div>
</div>

<script>
// 项目日志相关变量
let projectLogEventSource = null;
let autoScrollEnabled = true;
let logLines = [];

// 连接项目日志流
function connectProjectLogStream() {
    if (projectLogEventSource) {
        projectLogEventSource.close();
    }

    projectLogEventSource = new EventSource('{% url "project_log_stream" %}');

    projectLogEventSource.onmessage = function(event) {
        const logLine = event.data;
        addProjectLogLine(logLine);
    };

    projectLogEventSource.onerror = function(event) {
        console.error('日志流连接错误:', event);
        addProjectLogLine('[ERROR] 日志流连接失败，正在重试...');
        setTimeout(connectProjectLogStream, 5000);
    };

    console.log('项目日志流已连接');
}

// 添加项目日志行
function addProjectLogLine(line) {
    logLines.push(line);

    const logContent = document.getElementById('projectLogContent');
    const lineElement = document.createElement('div');
    lineElement.textContent = line;
    lineElement.style.marginBottom = '2px';

    // 错误消息标红
    if (line.includes('ERROR') || line.includes('FAILED')) {
        lineElement.style.color = '#ff4444';
    } else if (line.includes('WARN')) {
        lineElement.style.color = '#ffaa00';
    }

    logContent.appendChild(lineElement);

    // 自动滚动到底部
    if (autoScrollEnabled) {
        logContent.scrollTop = logContent.scrollHeight;
    }

    // 限制日志行数，防止内存泄漏
    if (logLines.length > 1000) {
        logLines = logLines.slice(-500);
        // 重新渲染日志内容
        logContent.innerHTML = '';
        logLines.forEach(line => {
            const elem = document.createElement('div');
            elem.textContent = line;
            elem.style.marginBottom = '2px';
            if (line.includes('ERROR') || line.includes('FAILED')) {
                elem.style.color = '#ff4444';
            } else if (line.includes('WARN')) {
                elem.style.color = '#ffaa00';
            }
            logContent.appendChild(elem);
        });
    }
}

// 清除项目日志
function clearProjectLogs() {
    if (confirm('确定要清空项目日志吗？')) {
        logLines = [];
        document.getElementById('projectLogContent').innerHTML = '<div class="text-center text-muted" style="color: #666;"><i class="fas fa-spinner fa-spin me-2"></i>日志已清空...</div>';
    }
}

// 切换自动滚动
function toggleAutoScroll() {
    autoScrollEnabled = !autoScrollEnabled;
    const statusElement = document.getElementById('scrollStatus');
    const iconElement = statusElement.previousElementSibling;

    if (autoScrollEnabled) {
        statusElement.textContent = '滚动';
        iconElement.className = 'fas fa-play me-1';
        // 立即滚动到底部
        const logContent = document.getElementById('projectLogContent');
        logContent.scrollTop = logContent.scrollHeight;
    } else {
        statusElement.textContent = '暂停';
        iconElement.className = 'fas fa-pause me-1';
    }
}

// 导出项目日志
function exportProjectLogs() {
    const logText = logLines.join('\n');
    const blob = new Blob([logText], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = `project_logs_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// 查看导入日志详情
function viewImportLog(logId) {
    fetch(`/import-log/${logId}/`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('importLogDetailContent').innerHTML = html;
            new bootstrap.Modal(document.getElementById('importLogDetailModal')).show();
        })
        .catch(error => {
            console.error('加载日志详情失败:', error);
            alert('加载日志详情失败');
        });
}

// 查看导入日志详情（另一种方式）
function viewImportLogDetail(logId) {
    window.open(`/import-log/${logId}/`, '_blank');
}

// 打开实时日志
function openRealtimeLog(logId) {
    window.open(`/realtime-log/${logId}/`, '_blank');
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    // 连接项目日志流
    connectProjectLogStream();

    // 自动刷新处理中的日志
    function refreshProcessingLogs() {
        const processingRows = document.querySelectorAll('.badge:contains("处理中")');
        if (processingRows.length > 0) {
            setTimeout(() => {
                location.reload();
            }, 5000); // 5秒后刷新
        }
    }

    refreshProcessingLogs();
});

// 页面卸载时关闭连接
window.addEventListener('beforeunload', function() {
    if (projectLogEventSource) {
        projectLogEventSource.close();
    }
});
</script>

<style>
.project-log-container::-webkit-scrollbar {
    width: 8px;
}

.project-log-container::-webkit-scrollbar-track {
    background: #2a2a2a;
}

.project-log-container::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 4px;
}

.project-log-container::-webkit-scrollbar-thumb:hover {
    background: #777;
}

.import-log-container::-webkit-scrollbar {
    width: 6px;
}

.import-log-container::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.import-log-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.import-log-container::-webkit-scrollbar-thumb:hover {
    background: #a1a1a1;
}

.clickable-row:hover {
    background-color: #f8f9fa !important;
}
</style>

{% endblock %}

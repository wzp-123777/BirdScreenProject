{% extends 'monitor/base.html' %}
{% load static %}

{% block content %}
<h2 class="mb-4" style="color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <i class="fas fa-upload me-2"></i>导入离线地图数据 (XLS格式)
</h2>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-file-excel me-2" style="color: #28a745;"></i>XLS文件上传
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="import_type" class="form-label">
                            <strong>导入类型</strong>
                        </label>
                        <select class="form-select" id="import_type" name="import_type" required>
                            <option value="bird">鸟情数据</option>
                            <option value="airport">机场数据</option>
                            <option value="geodata">地理数据 (Shapefile/GeoJSON)</option>
                        </select>
                        <div class="form-text">
                            选择要导入的数据类型
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="xls_file" class="form-label">
                            <strong>选择文件</strong>
                        </label>
                        <input type="file" class="form-control" id="xls_file" name="xls_file"
                               accept=".xls,.xlsx,.csv" required>
                        <div class="form-text">
                            <small class="text-info">
                                <i class="fas fa-info-circle me-1"></i>
                                上传后将自动创建实时日志监控，您可以在新窗口中查看导入进度
                            </small>
                        </div>
                        <div class="form-text">
                            支持 .xls、.xlsx 和 .csv 格式文件
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload me-2"></i>开始导入
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-info-circle me-2" style="color: #17a2b8;"></i>文件格式说明
            </div>
            <div class="card-body">
                <div id="bird-format" class="format-info">
                    <h6>鸟情数据文件格式：</h6>
                    <p><strong>必需列：</strong></p>
                    <ul class="mb-3">
                        <li><strong>鸟种</strong> - 鸟类名称</li>
                        <li><strong>数量</strong> - 鸟类数量（整数）</li>
                        <li><strong>位置</strong> - 发现位置描述</li>
                        <li><strong>纬度</strong> - 纬度坐标（必需）</li>
                        <li><strong>经度</strong> - 经度坐标（必需）</li>
                    </ul>

                    <p><strong>可选列：</strong></p>
                    <ul class="mb-3">
                        <li><strong>记录时间</strong> - 格式：YYYY-MM-DD HH:MM:SS</li>
                        <li><strong>入侵原因</strong> - 鸟类出现的原因</li>
                        <li><strong>备注</strong> - 其他说明信息</li>
                    </ul>
                </div>

                <div id="airport-format" class="format-info" style="display: none;">
                    <h6>机场数据文件格式（基于airports.csv标准）：</h6>
                    <p><strong>必需列：</strong></p>
                    <ul class="mb-3">
                        <li><strong>ident</strong> - 机场标识符（如：ZBAA, PEK）</li>
                        <li><strong>name</strong> - 机场全称</li>
                        <li><strong>latitude_deg</strong> - 纬度</li>
                        <li><strong>longitude_deg</strong> - 经度</li>
                    </ul>

                    <p><strong>可选列：</strong></p>
                    <ul class="mb-3">
                        <li><strong>type</strong> - 机场类型（large_airport, small_airport等）</li>
                        <li><strong>elevation_ft</strong> - 海拔高度（英尺）</li>
                        <li><strong>iso_country</strong> - 国家代码（如：CN, US）</li>
                        <li><strong>municipality</strong> - 城市名称</li>
                        <li><strong>icao_code</strong> - ICAO代码</li>
                        <li><strong>iata_code</strong> - IATA代码</li>
                    </ul>
                </div>

                <div id="geodata-format" class="format-info" style="display: none;">
                    <h6>地理数据文件格式：</h6>
                    <p><strong>支持格式：</strong></p>
                    <ul class="mb-3">
                        <li><strong>Shapefile (.shp)</strong> - ArcGIS标准矢量格式</li>
                        <li><strong>GeoJSON (.geojson)</strong> - JSON格式地理数据</li>
                        <li><strong>KML (.kml)</strong> - Google Earth格式</li>
                    </ul>

                    <p><strong>自动提取：</strong></p>
                    <ul class="mb-3">
                        <li>几何坐标（点、线、面）</li>
                        <li>属性数据</li>
                        <li>坐标系信息</li>
                    </ul>

                    <p><strong>注意：</strong></p>
                    <ul class="mb-3">
                        <li>系统会自动提取几何体的经纬度坐标</li>
                        <li>Shapefile需要同时上传.shp, .dbf, .shx等配套文件</li>
                        <li>坐标系应为WGS84 (EPSG:4326)</li>
                    </ul>
                </div>

                <div class="alert alert-info">
                    <small>
                        <i class="fas fa-lightbulb me-1"></i>
                        <span id="bird-tip">如果鸟种不存在，系统会自动创建（危险等级默认为3）</span>
                        <span id="airport-tip" style="display: none;">机场数据支持批量导入，用于地图背景显示</span>
                        <span id="geodata-tip" style="display: none;">地理数据将自动提取坐标，支持点线面几何体</span>
                    </small>
                </div>
            </div>
        </div>

        <!-- 示例文件下载 -->
        <div class="card mt-3">
            <div class="card-header">
                <i class="fas fa-download me-2" style="color: #ffc107;"></i>下载示例文件
            </div>
            <div class="card-body">
                <div id="bird-samples">
                    <p class="mb-2">下载鸟情数据示例文件：</p>
                    <a href="{% static 'monitor/sample_bird_data.xlsx' %}" class="btn btn-outline-primary btn-sm me-2" download>
                        <i class="fas fa-download me-1"></i>XLS示例
                    </a>
                    <a href="{% static 'monitor/sample_bird_data.csv' %}" class="btn btn-outline-success btn-sm" download>
                        <i class="fas fa-download me-1"></i>CSV示例
                    </a>
                </div>

                <div id="airport-samples" style="display: none;">
                    <p class="mb-2">下载机场数据示例文件：</p>
                    <p class="text-muted small mb-2">参考文件：D:\airports.csv</p>
                    <a href="{% static 'monitor/sample_airport_data.csv' %}" class="btn btn-outline-success btn-sm" download>
                        <i class="fas fa-download me-1"></i>机场CSV示例
                    </a>
                </div>

                <div id="geodata-samples" style="display: none;">
                    <p class="mb-2">地理数据文件示例：</p>
                    <p class="text-muted small mb-2">从ArcGIS Desktop导出的文件格式</p>
                    <div class="row">
                        <div class="col-12">
                            <small>
                                <strong>Shapefile格式：</strong><br>
                                - point.shp (几何数据)<br>
                                - point.dbf (属性数据)<br>
                                - point.shx (索引文件)<br>
                                - point.prj (坐标系信息)<br><br>
                                <strong>GeoJSON格式：</strong><br>
                                - 单个.geojson文件包含几何和属性<br><br>
                                <strong>KML格式：</strong><br>
                                - Google Earth兼容格式
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 导入结果显示 -->
{% if processing %}
<div class="row mt-3">
    <div class="col-md-12">
        <div class="alert alert-info">
            <i class="fas fa-spinner fa-spin me-2"></i>{{ message }}
            <div class="mt-3">
                <a href="{% url 'realtime_log' log_id %}" class="btn btn-success me-2" target="_blank">
                    <i class="fas fa-terminal me-2"></i>打开实时日志监控
                </a>
                <small class="text-muted d-block mt-2">
                    <i class="fas fa-info-circle me-1"></i>
                    点击上方按钮在新窗口中查看实时导入进度，系统会自动更新日志内容。
                </small>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if success %}
<div class="row mt-3">
    <div class="col-md-12">
        <div class="alert alert-success">
            <i class="fas fa-check-circle me-2"></i>{{ success }}
            {% if log_id %}
            <div class="mt-2">
                <a href="{% url 'realtime_log' log_id %}" class="btn btn-sm btn-outline-success me-2" target="_blank">
                    <i class="fas fa-terminal me-1"></i>实时日志监控
                </a>
                <a href="{% url 'import_log_detail' log_id %}" class="btn btn-sm btn-outline-info me-2">
                    <i class="fas fa-eye me-1"></i>详细日志
                </a>
                <a href="{% url 'import_logs' %}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-history me-1"></i>所有日志
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

{% if error %}
<div class="row mt-3">
    <div class="col-md-12">
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
        </div>
    </div>
</div>
{% endif %}

{% if error_count %}
<div class="row mt-3">
    <div class="col-md-12">
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            导入过程中发现 {{ error_count }} 个错误：
            <button class="btn btn-link btn-sm p-0 ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#errorDetails">
                查看详情
            </button>
        </div>

        <div class="collapse" id="errorDetails">
            <div class="card">
                <div class="card-body">
                    <ul class="mb-0">
                        {% for error_msg in errors %}
                        <li class="text-danger">{{ error_msg }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 文件格式示例表格 -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-table me-2" style="color: #6f42c1;"></i>XLS文件格式示例
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped mb-0">
                        <thead>
                            <tr>
                                <th>鸟种</th>
                                <th>数量</th>
                                <th>位置</th>
                                <th>纬度</th>
                                <th>经度</th>
                                <th>记录时间</th>
                                <th>入侵原因</th>
                                <th>备注</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>老鹰</td>
                                <td>3</td>
                                <td>跑道北侧</td>
                                <td>39.9042</td>
                                <td>116.4074</td>
                                <td>2024-01-15 08:30:00</td>
                                <td>觅食活动</td>
                                <td>大型猛禽</td>
                            </tr>
                            <tr>
                                <td>海鸥</td>
                                <td>5</td>
                                <td>湖边区域</td>
                                <td>39.9142</td>
                                <td>116.4174</td>
                                <td>2024-01-16 14:20:00</td>
                                <td>迁徙途中</td>
                                <td>集群活动</td>
                            </tr>
                            <tr>
                                <td>麻雀</td>
                                <td>12</td>
                                <td>绿化带</td>
                                <td>39.8942</td>
                                <td>116.3974</td>
                                <td>2024-01-17 10:15:00</td>
                                <td>栖息觅食</td>
                                <td>常见鸟类</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 导入类型切换
document.getElementById('import_type').addEventListener('change', function(e) {
    const importType = e.target.value;
    const birdFormat = document.getElementById('bird-format');
    const airportFormat = document.getElementById('airport-format');
    const geodataFormat = document.getElementById('geodata-format');
    const birdTip = document.getElementById('bird-tip');
    const airportTip = document.getElementById('airport-tip');
    const geodataTip = document.getElementById('geodata-tip') || document.createElement('span');
    const birdSamples = document.getElementById('bird-samples');
    const airportSamples = document.getElementById('airport-samples');
    const geodataSamples = document.getElementById('geodata-samples') || document.createElement('div');

    // 隐藏所有格式说明
    birdFormat.style.display = 'none';
    airportFormat.style.display = 'none';
    geodataFormat.style.display = 'none';

    // 隐藏所有提示
    birdTip.style.display = 'none';
    airportTip.style.display = 'none';
    if (document.getElementById('geodata-tip')) {
        document.getElementById('geodata-tip').style.display = 'none';
    }

    // 隐藏所有示例
    birdSamples.style.display = 'none';
    airportSamples.style.display = 'none';
    if (document.getElementById('geodata-samples')) {
        document.getElementById('geodata-samples').style.display = 'none';
    }

    // 根据选择显示相应内容
    if (importType === 'airport') {
        airportFormat.style.display = 'block';
        airportTip.style.display = 'inline';
        airportSamples.style.display = 'block';
    } else if (importType === 'geodata') {
        geodataFormat.style.display = 'block';
        if (document.getElementById('geodata-tip')) {
            document.getElementById('geodata-tip').style.display = 'inline';
        }
        if (document.getElementById('geodata-samples')) {
            document.getElementById('geodata-samples').style.display = 'block';
        }
    } else {
        birdFormat.style.display = 'block';
        birdTip.style.display = 'inline';
        birdSamples.style.display = 'block';
    }
});

// 文件选择验证
document.getElementById('xls_file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const importType = document.getElementById('import_type').value;

    if (file) {
        const fileName = file.name.toLowerCase();
        let validExtensions = [];

        if (importType === 'bird') {
            validExtensions = ['.xls', '.xlsx', '.csv'];
        } else if (importType === 'airport') {
            validExtensions = ['.csv'];
        } else if (importType === 'geodata') {
            validExtensions = ['.shp', '.geojson', '.json', '.kml'];
        }

        const isValid = validExtensions.some(ext => fileName.endsWith(ext));

        if (!isValid) {
            const formatNames = {
                'bird': 'XLS/XLSX/CSV',
                'airport': 'CSV',
                'geodata': 'SHP/GeoJSON/JSON/KML'
            };
            alert(`请选择有效的${formatNames[importType]}文件`);
            e.target.value = '';
        } else {
            // 显示文件大小
            const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
            console.log(`选择的文件: ${file.name} (${sizeMB} MB)`);

            // 检查文件大小（限制为100MB for地理数据）
            const maxSize = importType === 'geodata' ? 100 * 1024 * 1024 : 50 * 1024 * 1024;
            if (file.size > maxSize) {
                alert(`文件大小不能超过${maxSize / (1024 * 1024)}MB`);
                e.target.value = '';
            }
        }
    }
});

// 页面加载完成后，如果是处理状态，自动打开实时日志
document.addEventListener('DOMContentLoaded', function() {
    {% if processing and log_id %}
    // 自动打开实时日志窗口
    setTimeout(function() {
        const realtimeLogUrl = "{% url 'realtime_log' log_id %}";
        window.open(realtimeLogUrl, 'realtime_log', 'width=1200,height=800,scrollbars=yes,resizable=yes');

        // 显示提示信息
        const alertDiv = document.querySelector('.alert-info');
        if (alertDiv) {
            alertDiv.innerHTML += '<br><small class="text-success"><i class="fas fa-external-link-alt me-1"></i>实时日志窗口已自动打开！</small>';
        }
    }, 1000);
    {% endif %}
});
</script>
{% endblock %}

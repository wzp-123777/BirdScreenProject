{% extends 'monitor/base.html' %}
{% load static %}

{% block content %}
<h2 class="mb-4" style="color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <i class="fas fa-globe me-2"></i>3Dé¸Ÿæƒ…åœ°å›¾
</h2>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-cube me-2"></i>é¸Ÿæƒ…æ´»åŠ¨3Dåˆ†å¸ƒç›‘æ§
                <div class="float-end">
                    <small>
                        <i class="fas fa-info-circle me-1"></i>
                        å…¨æœºåœºæ˜¾ç¤º | å®æ—¶ä½ç½® | æ™ºèƒ½æœç´¢ | æµç•…ç¼©æ”¾
                    </small>
                </div>
            </div>
            <div class="card-body p-0">
                <!-- å¯æ‹–æ‹½æœç´¢æ§ä»¶ -->
                <div id="searchPanel" class="position-absolute" style="top: 20px; left: 20px; z-index: 1001; width: 320px; cursor: move; pointer-events: auto;">
                    <div class="card shadow-lg border-primary">
                        <div class="card-header bg-primary text-white py-2 d-flex justify-content-between align-items-center" style="cursor: move;">
                            <span><i class="fas fa-search me-1"></i>æœç´¢å·¥å…·</span>
                            <div>
                                <button class="btn btn-sm btn-outline-light me-1" onclick="toggleSearchPanel()" title="æŠ˜å /å±•å¼€">
                                    <i class="fas fa-chevron-up" id="searchToggleIcon"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-light" onclick="closeSearchPanel()" title="å…³é—­">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-2" id="searchPanelBody">
                            <!-- åæ ‡æœç´¢ -->
                            <div class="mb-2">
                                <label class="form-label small mb-1">ğŸ“ åæ ‡å®šä½</label>
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" id="coordInput" placeholder="ç»åº¦,çº¬åº¦ (å¦‚: 116.4074,39.9042)" title="è¾“å…¥ç»åº¦å’Œçº¬åº¦ï¼Œç”¨é€—å·åˆ†éš”">
                                    <button class="btn btn-outline-primary btn-sm" onclick="gotoCoordinates()">
                                        <i class="fas fa-search-location"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- æœºåœºæœç´¢ -->
                            <div class="mb-2">
                                <label class="form-label small mb-1">âœˆï¸ æœºåœºæœç´¢</label>
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" id="airportSearch" placeholder="æœºåœºä»£ç /åç§° (å¦‚: PEK, åŒ—äº¬)" title="è¾“å…¥æœºåœºä»£ç æˆ–åç§°">
                                    <button class="btn btn-outline-info btn-sm" onclick="searchAirport()">
                                        <i class="fas fa-plane"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- ç»“æœæ˜¾ç¤º -->
                            <div id="searchResults" class="mt-2" style="max-height: 200px; overflow-y: auto; display: none;">
                                <div id="searchResultsContent"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å¯æ‹–æ‹½å½“å‰ä½ç½®ä¿¡æ¯é¢æ¿ -->
                <div id="positionPanel" class="position-absolute" style="top: 20px; right: 20px; z-index: 1000; width: 280px; cursor: move;">
                    <div class="card shadow-lg border-info">
                        <div class="card-header bg-info text-white py-2 d-flex justify-content-between align-items-center" style="cursor: move;">
                            <span><i class="fas fa-location-arrow me-1"></i>å½“å‰ä½ç½®ä¿¡æ¯</span>
                            <div>
                                <button class="btn btn-sm btn-outline-light me-1" onclick="togglePositionPanel()" title="æŠ˜å /å±•å¼€">
                                    <i class="fas fa-chevron-up" id="positionToggleIcon"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-light" onclick="closePositionPanel()" title="å…³é—­">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-2" id="positionPanelBody">
                            <div id="currentPosition" class="small">
                                <div class="text-muted mb-2">
                                    <i class="fas fa-spinner fa-spin me-1"></i>æ­£åœ¨è·å–ä½ç½®ä¿¡æ¯...
                                </div>
                                <div id="positionDetails" style="display: none;">
                                    <div class="mb-1"><strong>ç»åº¦:</strong> <span id="currentLon">--</span></div>
                                    <div class="mb-1"><strong>çº¬åº¦:</strong> <span id="currentLat">--</span></div>
                                    <div class="mb-1"><strong>é«˜åº¦:</strong> <span id="currentAlt">--</span> m</div>
                                    <div class="mb-1"><strong>æœå‘:</strong> <span id="currentHeading">--</span>Â°</div>
                                    <div class="mb-1"><strong>ä¿¯è§†:</strong> <span id="currentTilt">--</span>Â°</div>
                                    <hr class="my-2">
                                    <div class="mb-1"><strong>é™„è¿‘æœºåœº:</strong> <span id="nearestAirport">--</span></div>
                                    <div class="mb-1"><strong>é¸Ÿæƒ…è®°å½•:</strong> <span id="nearbyBirds">--</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è§†å›¾æ§åˆ¶ -->
                <div class="position-absolute" style="top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000;">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-secondary" onclick="resetView()">
                            <i class="fas fa-home me-1"></i>é‡ç½®è§†å›¾
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" id="airportDropdownBtn" title="ç‚¹å‡»é€‰æ‹©è¦æ˜¾ç¤ºçš„æœºåœºç±»å‹" onclick="console.log('ä¸‹æ‹‰èœå•è¢«ç‚¹å‡»')">
                                <i class="fas fa-plane me-1"></i>æœºåœºæ˜¾ç¤º <span class="badge bg-primary">84K+</span>
                            </button>
                            <ul class="dropdown-menu shadow-lg">
                                <li><h6 class="dropdown-header"><i class="fas fa-info-circle me-1"></i>é€‰æ‹©æœºåœºæ˜¾ç¤ºèŒƒå›´</h6></li>
                                <li><a class="dropdown-item active" href="#" onclick="console.log('ç‚¹å‡»ä¸­å›½æœºåœº'); loadAirports('china')">
                                    <i class="fas fa-check text-success me-2"></i><strong>ä¸­å›½æœºåœº</strong> (750ä¸ª)
                                    <small class="text-muted d-block">æ¨è - æµç•…æ€§èƒ½</small>
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="console.log('ç‚¹å‡»ä¸»è¦æœºåœº'); loadAirports('major')">
                                    <i class="fas fa-building me-2"></i><strong>ä¸»è¦æœºåœº</strong> (4,859ä¸ª)
                                    <small class="text-muted d-block">æ¢çº½æœºåœº</small>
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="console.log('ç‚¹å‡»ç²¾ç®€å…¨çƒ'); loadAirports('simplified')">
                                    <i class="fas fa-globe-americas me-2"></i><strong>ç²¾ç®€å…¨çƒ</strong> (5,000ä¸ª)
                                    <small class="text-muted d-block">å¿«é€Ÿæµè§ˆ</small>
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header text-warning"><i class="fas fa-exclamation-triangle me-1"></i>å¤§æ•°æ®é›†è­¦å‘Š</h6></li>
                                <li><a class="dropdown-item text-warning" href="#" onclick="console.log('ç‚¹å‡»å…¨çƒæœºåœº'); loadAirports('world')">
                                    <i class="fas fa-exclamation-triangle me-2"></i><strong>å…¨çƒæœºåœº</strong> (10Kæ˜¾ç¤º)
                                    <small class="text-muted d-block">å¯èƒ½å½±å“æ€§èƒ½</small>
                                </a></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="console.log('ç‚¹å‡»å®Œæ•´å…¨çƒ'); loadAirports('complete')">
                                    <i class="fas fa-skull-crossbones me-2"></i><strong>å®Œæ•´å…¨çƒ</strong> (84Kå…¨éƒ¨)
                                    <small class="text-muted d-block">âš ï¸ ä¸¥é‡æ€§èƒ½å½±å“</small>
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><small class="dropdown-item-text text-muted">
                                    <i class="fas fa-database me-1"></i>æ•°æ®æ¥æº: OurAirports
                                </small></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- æ•°æ®åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                <div id="dataStatus" class="position-absolute top-0 start-0 p-2 mt-3 ms-3" style="z-index: 1000; background: rgba(0,0,0,0.8); color: white; border-radius: 5px; font-size: 12px;">
                    <small>
                        <i class="fas fa-database me-1"></i>
                        <span id="airportStatus"><i class="fas fa-spinner fa-spin me-1"></i>æœºåœº: åŠ è½½ä¸­...</span><br>
                        <span id="birdStatus"><i class="fas fa-spinner fa-spin me-1"></i>é¸Ÿæƒ…: åŠ è½½ä¸­...</span><br>
                        <span id="dataSource">æ•°æ®æº: airports.csv</span>
                    </small>
                </div>

                <div id="mapView" style="height: 600px; width: 100%; image-rendering: -webkit-optimize-contrast; image-rendering: crisp-edges;"></div>
            </div>
            <div class="card-footer bg-light">
                <div class="row text-center">
                    <div class="col-md-3">
                        <i class="fas fa-mouse-pointer text-primary mb-1"></i>
                        <br><small><strong>æ‹–æ‹½</strong><br>æ—‹è½¬è§†è§’</small>
                    </div>
                    <div class="col-md-3">
                        <i class="fas fa-search-plus text-success mb-1"></i>
                        <br><small><strong>æ»šè½®</strong><br>æ”¾å¤§ç¼©å°</small>
                    </div>
                    <div class="col-md-3">
                        <i class="fas fa-arrows-alt text-warning mb-1"></i>
                        <br><small><strong>æœç´¢</strong><br>å®šä½æœºåœº</small>
                    </div>
                    <div class="col-md-3">
                        <i class="fas fa-info-circle text-info mb-1"></i>
                        <br><small><strong>ä½ç½®</strong><br>å®æ—¶ä¿¡æ¯</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ArcGIS API -->
<script src="https://js.arcgis.com/4.28/"></script>
<script>
console.log("ğŸš€ ç®€åŒ–ç‰ˆ3Dé¸Ÿæƒ…åœ°å›¾åŠ è½½...");

// å…¨å±€å˜é‡
let view = null;
let airports = [];
let birdRecords = [];
let airportLayer = null;
let birdLayer = null;

// åŸºç¡€åœ°å›¾å®ç°
require([
    "esri/Map",
    "esri/views/SceneView",
    "esri/layers/GraphicsLayer",
    "esri/Graphic",
    "esri/geometry/Point",
    "esri/symbols/SimpleMarkerSymbol",
    "esri/PopupTemplate"
], function(Map, SceneView, GraphicsLayer, Graphic, Point, SimpleMarkerSymbol, PopupTemplate) {

    console.log("âœ… ArcGISæ¨¡å—åŠ è½½æˆåŠŸ");

    // æ˜¾ç¤ºæœºåœºé€‰æ‹©å™¨æç¤º
    setTimeout(function() {
        window.showAirportSelectorHint();
    }, 2000);

    try {
        // åˆ›å»ºè½»é‡çº§åœ°å›¾
        const map = new Map({
            basemap: "satellite" // åªä½¿ç”¨å«æ˜Ÿå½±åƒï¼Œç§»é™¤åœ°å½¢æ•°æ®
        });

        // åˆ›å»ºå›¾å±‚
        airportLayer = new GraphicsLayer();
        map.add(airportLayer);

        birdLayer = new GraphicsLayer();
        map.add(birdLayer);

        console.log("âœ… å›¾å±‚åˆ›å»ºæˆåŠŸ");

        // åˆ›å»ºè½»é‡çº§3Dè§†å›¾
        view = new SceneView({
            container: "mapView",
            map: map,
            camera: {
                position: [117.346000671, 39.1244010925, 1000], // å¤©æ´¥æœºåœºåæ ‡ï¼Œé™ä½é«˜åº¦å‡å°‘å¤æ‚åº¦
                heading: 0,
                tilt: 15 // é™ä½å€¾è§’ï¼Œå‡å°‘3Dè®¡ç®—
            },
            qualityProfile: "low", // ä½¿ç”¨æœ€ä½è´¨é‡ä»¥æé«˜æ€§èƒ½
            pixelRatio: 1 // é™ä½åƒç´ å¯†åº¦
        });

        console.log("âœ… SceneViewåˆ›å»ºæˆåŠŸ");

        // å®šä¹‰å…¨å±€å‡½æ•°
        window.showAirportSelectorHint = function() {
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¾ç¤ºè¿‡æç¤º
            if (localStorage.getItem('airportHintShown')) {
                return;
            }

            // åˆ›å»ºæç¤ºæ¡†
            const hintHtml = `
                <div id="airportHint" class="alert alert-info alert-dismissible position-fixed" style="top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; max-width: 400px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    <h6 class="alert-heading"><i class="fas fa-plane me-2"></i>å…¨çƒæœºåœºåŠŸèƒ½</h6>
                    <p class="mb-2">ç°åœ¨æ”¯æŒæ˜¾ç¤ºå…¨çƒ84,294ä¸ªæœºåœºï¼</p>
                    <div class="mb-3">
                        <strong>ç‚¹å‡»ä¸Šæ–¹"æœºåœºæ˜¾ç¤º"æŒ‰é’®é€‰æ‹©:</strong>
                        <ul class="mb-2 mt-2">
                            <li><small>ğŸŸ¦ ä¸­å›½æœºåœº (750ä¸ª) - é»˜è®¤</small></li>
                            <li><small>ğŸŸ¨ ä¸»è¦æœºåœº (4,859ä¸ª)</small></li>
                            <li><small>ğŸŸ© ç²¾ç®€å…¨çƒ (5,000ä¸ª)</small></li>
                            <li><small>ğŸŸ¨ å…¨çƒæœºåœº (10Kæ˜¾ç¤º)</small></li>
                            <li><small>ğŸ”´ å®Œæ•´å…¨çƒ (84Kå…¨éƒ¨)</small></li>
                        </ul>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary btn-sm" onclick="highlightAirportButton()">
                            <i class="fas fa-hand-pointer me-1"></i>æ‰¾åˆ°æŒ‰é’®
                        </button>
                        <button class="btn btn-secondary btn-sm" data-bs-dismiss="alert">
                            çŸ¥é“äº†
                        </button>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', hintHtml);

            // æ ‡è®°å·²æ˜¾ç¤º
            localStorage.setItem('airportHintShown', 'true');
        };

        window.highlightAirportButton = function() {
            const btn = document.getElementById('airportDropdownBtn');
            if (btn) {
                // é«˜äº®æŒ‰é’®
                btn.style.animation = 'pulse 1s infinite';
                btn.style.boxShadow = '0 0 20px rgba(0, 123, 255, 0.8)';
                btn.style.borderColor = '#007bff';

                // 3ç§’åæ¢å¤æ­£å¸¸
                setTimeout(() => {
                    btn.style.animation = '';
                    btn.style.boxShadow = '';
                    btn.style.borderColor = '';
                }, 3000);

                // å…³é—­æç¤ºæ¡†
                const hint = document.getElementById('airportHint');
                if (hint) {
                    hint.remove();
                }
            }
        };

        // åŠ è½½æ•°æ® - é»˜è®¤åŠ è½½ä¸­å›½æœºåœº
        loadAirports('china');
        loadBirdRecords();

        // æœºåœºæ•°æ®åŠ è½½å‡½æ•° - æ”¯æŒä¸åŒæ•°æ®æº
        function loadAirports(source = 'china') {
            console.log(`ğŸ“ å¼€å§‹åŠ è½½æœºåœºæ•°æ® (${source})...`);
            console.log('airportLayerå­˜åœ¨:', typeof airportLayer);
            console.log('airportLayerå¯¹è±¡:', airportLayer);

            // æ£€æŸ¥airportLayeræ˜¯å¦å·²åˆå§‹åŒ–
            if (!airportLayer) {
                console.error('âŒ airportLayeræœªåˆå§‹åŒ–ï¼Œæ— æ³•åŠ è½½æœºåœºæ•°æ®');
                alert('åœ°å›¾å›¾å±‚æœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }

            // æ¸…é™¤ç°æœ‰æœºåœºæ ‡è®°
            try {
                airportLayer.removeAll();
                console.log('âœ… æ¸…é™¤ç°æœ‰æœºåœºæ ‡è®°æˆåŠŸ');
            } catch (error) {
                console.error('âŒ æ¸…é™¤æœºåœºæ ‡è®°å¤±è´¥:', error);
            }

            let url, displayName, maxDisplay;

            switch(source) {
                case 'china':
                    url = '{% static "monitor/airports_china.json" %}';
                    displayName = 'ä¸­å›½æœºåœº';
                    maxDisplay = null; // æ˜¾ç¤ºå…¨éƒ¨
                    break;
                case 'major':
                    url = '{% static "monitor/airports_major.json" %}';
                    displayName = 'ä¸»è¦æœºåœº';
                    maxDisplay = 200; // é™åˆ¶æ˜¾ç¤ºæ•°é‡é¿å…å¡é¡¿
                    break;
                case 'simplified':
                    url = '{% static "monitor/airports_simplified.json" %}';
                    displayName = 'ç²¾ç®€å…¨çƒæœºåœº';
                    maxDisplay = 500; // é™åˆ¶æ˜¾ç¤ºæ•°é‡
                    break;
                case 'world':
                    // ä½¿ç”¨åŒ…å«10,000ä¸ªæœºåœºçš„ä¸–ç•Œæ•°æ®é›†
                    alert('âš ï¸ æ˜¾ç¤ºå…¨çƒæœºåœº (10,000ä¸ª) å¯èƒ½ä¼šå½±å“åœ°å›¾æ€§èƒ½ï¼\n\nå¦‚æœåœ°å›¾å˜å¾—å¾ˆå¡ï¼Œè¯·åˆ‡æ¢åˆ°å…¶ä»–æ˜¾ç¤ºé€‰é¡¹ã€‚');
                    url = '{% static "monitor/airports_world.json" %}';
                    displayName = 'å…¨çƒæœºåœº';
                    maxDisplay = 2000; // é™åˆ¶æ˜¾ç¤ºå‰2000ä¸ªä»¥ä¿è¯æ€§èƒ½
                    break;
                case 'complete':
                    // ä½¿ç”¨åŒ…å«å…¨éƒ¨84,294ä¸ªæœºåœºçš„å®Œæ•´æ•°æ®é›†
                    const confirmed = confirm('âš ï¸ è­¦å‘Šï¼šæ˜¾ç¤ºå®Œæ•´å…¨çƒæœºåœº (84,294ä¸ª) å°†ä¼šï¼š\n\n' +
                        'â€¢ åŠ è½½24.7MBçš„æ•°æ®æ–‡ä»¶\n' +
                        'â€¢ åœ¨åœ°å›¾ä¸Šæ˜¾ç¤º8ä¸‡å¤šä¸ªæ ‡è®°\n' +
                        'â€¢ ä¸¥é‡å½±å“åœ°å›¾æ€§èƒ½å’Œå“åº”é€Ÿåº¦\n' +
                        'â€¢ å¯èƒ½å¯¼è‡´æµè§ˆå™¨å¡æ­»æˆ–å´©æºƒ\n\n' +
                        'å»ºè®®ä½¿ç”¨å…¶ä»–é€‰é¡¹è·å¾—æ›´å¥½çš„ä½“éªŒã€‚\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ');

                    if (!confirmed) {
                        return; // ç”¨æˆ·å–æ¶ˆï¼Œä¸åŠ è½½
                    }

                    alert('æ­£åœ¨åŠ è½½å®Œæ•´å…¨çƒæœºåœºæ•°æ®...\n\nè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚');
                    url = '{% static "monitor/airports_all.json" %}';
                    displayName = 'å®Œæ•´å…¨çƒæœºåœº';
                    maxDisplay = 5000; // é™åˆ¶åˆå§‹æ˜¾ç¤º5000ä¸ªï¼Œé¿å…å®Œå…¨å¡æ­»
                    break;
                default:
                    url = '{% static "monitor/airports_china.json" %}';
                    displayName = 'ä¸­å›½æœºåœº';
                    maxDisplay = null;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('airportStatus').innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i>${displayName}: åŠ è½½ä¸­...`;

            console.log('æ­£åœ¨è¯·æ±‚URL:', url);
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const totalCount = data.features.length;
                    console.log(`âœ… ä»æœ¬åœ°æ–‡ä»¶åŠ è½½äº† ${totalCount} ä¸ª${displayName}`);

                    // è½¬æ¢ä¸ºå†…éƒ¨æ ¼å¼
                    airports = data.features.map(feature => ({
                        ...feature.properties,
                        latitude: feature.geometry.coordinates[1],
                        longitude: feature.geometry.coordinates[0]
                    }));

                    // ç¡®å®šæ˜¾ç¤ºæ•°é‡
                    const displayCount = maxDisplay ? Math.min(maxDisplay, airports.length) : airports.length;

                    // æ˜¾ç¤ºæœºåœºæ ‡è®°
                    for (let i = 0; i < displayCount; i++) {
                        addAirportPoint(airports[i]);
                    }

                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    const statusText = maxDisplay && displayCount < totalCount ?
                        `${displayName}: ${displayCount}/${totalCount}ä¸ª âœ“` :
                        `${displayName}: ${displayCount}ä¸ª âœ“`;

                    document.getElementById('airportStatus').innerHTML = `<i class="fas fa-check-circle text-success me-1"></i>${statusText}`;

                    console.log(`ğŸ“ å·²æ˜¾ç¤º ${displayCount} ä¸ª${displayName}æ ‡è®°`);

                    // æ ¹æ®æ•°æ®æºç±»å‹ç»™å‡ºä¸åŒçš„è­¦å‘Šå’Œä¿¡æ¯
                    if (source === 'world' && displayCount < totalCount) {
                        setTimeout(() => {
                            alert(`âš ï¸ æ€§èƒ½è­¦å‘Šï¼š\n\nå…¨çƒæœºåœºæ•°æ®é‡è¾ƒå¤§ï¼Œå·²é™åˆ¶æ˜¾ç¤º${displayCount}/${totalCount}ä¸ªæœºåœºã€‚\n\nå¦‚éœ€æŸ¥çœ‹æ›´å¤šæœºåœºï¼Œè¯·ä½¿ç”¨"å®Œæ•´å…¨çƒ"é€‰é¡¹ï¼Œä½†è¿™ä¼šä¸¥é‡å½±å“æ€§èƒ½ã€‚`);
                        }, 1000);
                    } else if (source === 'complete') {
                        if (displayCount < totalCount) {
                            setTimeout(() => {
                                alert(`ğŸš¨ æ€§èƒ½ä¸¥é‡è­¦å‘Šï¼š\n\nå®Œæ•´å…¨çƒæœºåœºæ•°æ®å·²åŠ è½½${totalCount}ä¸ªæœºåœºï¼Œä½†ä¸ºäº†ä¿æŠ¤æ€§èƒ½ï¼Œåªæ˜¾ç¤ºå‰${displayCount}ä¸ªæ ‡è®°ã€‚\n\nâ€¢ æ€»æœºåœºæ•°ï¼š${totalCount.toLocaleString()}\nâ€¢ å½“å‰æ˜¾ç¤ºï¼š${displayCount.toLocaleString()}\nâ€¢ éšè—æœºåœºï¼š${(totalCount - displayCount).toLocaleString()}\n\nåœ°å›¾å¯èƒ½å˜å¾—éå¸¸å¡é¡¿ï¼Œå»ºè®®åˆ‡æ¢åˆ°å…¶ä»–æ˜¾ç¤ºé€‰é¡¹ã€‚`);
                            }, 2000);
                        } else {
                            setTimeout(() => {
                                alert(`ğŸš¨ æç«¯æ€§èƒ½è­¦å‘Šï¼š\n\næ‚¨æ­£åœ¨æ˜¾ç¤ºå…¨éƒ¨${totalCount.toLocaleString()}ä¸ªå…¨çƒæœºåœºï¼\n\nâ€¢ æ•°æ®å¤§å°ï¼š24.7MB\nâ€¢ æ ‡è®°æ•°é‡ï¼š${totalCount.toLocaleString()}\nâ€¢ é¢„æœŸå½±å“ï¼šä¸¥é‡å¡é¡¿\n\nå»ºè®®ç«‹å³åˆ‡æ¢åˆ°å…¶ä»–æ˜¾ç¤ºé€‰é¡¹ä»¥æ¢å¤æ­£å¸¸æ€§èƒ½ã€‚`);
                            }, 3000);
                        }
                    }

                    // æ›´æ–°ä¸‹æ‹‰èœå•æ¿€æ´»çŠ¶æ€
                    updateAirportMenuActive(source);
                })
                .catch(error => {
                    console.error(`âŒ åŠ è½½${displayName}æ•°æ®å¤±è´¥:`, error);
                    console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                    console.error('é”™è¯¯å †æ ˆ:', error.stack);
                    document.getElementById('airportStatus').innerHTML = `<i class="fas fa-times-circle text-danger me-1"></i>${displayName}: åŠ è½½å¤±è´¥ âœ—`;

                    alert(`åŠ è½½${displayName}æ•°æ®å¤±è´¥: ${error.message}\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢é‡è¯•ã€‚`);

                    // å¦‚æœä¸»è¦æ•°æ®æºå¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ•°æ®æº
                    if (source === 'china') {
                        console.log('ğŸ”„ å°è¯•åŠ è½½å¤‡ç”¨æœºåœºæ•°æ®...');
                        setTimeout(() => loadAirports('major'), 1000);
                    }
                });
        }

        // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.loadAirports = loadAirports;
        window.showAirportSelectorHint = showAirportSelectorHint;
        window.highlightAirportButton = highlightAirportButton;
        console.log("âœ… æ‰€æœ‰å‡½æ•°å·²æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ");

        function loadBirdRecords() {
            console.log("ğŸ¦ å¼€å§‹åŠ è½½é¸Ÿæƒ…æ•°æ®...");

            fetch('{% static "monitor/bird_records_local.json" %}')
                .then(response => response.json())
                .then(data => {
                    console.log(`âœ… ä»æœ¬åœ°æ–‡ä»¶åŠ è½½äº† ${data.length} æ¡é¸Ÿæƒ…è®°å½•`);
                    birdRecords = data;
                    document.getElementById('birdStatus').innerHTML = `<i class="fas fa-check-circle text-success me-1"></i>é¸Ÿæƒ…: ${data.length}æ¡ âœ“`;

                    data.forEach(record => {
                        if (record.latitude && record.longitude) {
                            addBirdPoint(record);
                        }
                    });

                    console.log(`ğŸ¦ å·²æ˜¾ç¤º ${data.length} ä¸ªé¸Ÿæƒ…æ ‡è®°`);
                })
                .catch(error => {
                    console.error('âŒ åŠ è½½é¸Ÿæƒ…æ•°æ®å¤±è´¥:', error);
                    document.getElementById('birdStatus').innerHTML = `<i class="fas fa-times-circle text-danger me-1"></i>é¸Ÿæƒ…: åŠ è½½å¤±è´¥ âœ—`;
                });
        }

        function addAirportPoint(airport) {
            const point = new Point({
                longitude: airport.longitude,
                latitude: airport.latitude
            });

            // æ ¹æ®æœºåœºç±»å‹è®¾ç½®ä¸åŒå¤§å°çš„è“è‰²è±å½¢æ ‡è®°
            let size = 8;
            let color = [0, 123, 255, 0.8]; // é»˜è®¤è“è‰²

            if (airport.airport_type === 'large_airport') {
                size = 12;
                color = [0, 123, 255, 1.0]; // å¤§å‹æœºåœºæ›´æ·±è“è‰²
            } else if (airport.airport_type === 'medium_airport') {
                size = 10;
                color = [0, 123, 255, 0.9]; // ä¸­å‹æœºåœºæ ‡å‡†è“è‰²
            }

            const symbol = new SimpleMarkerSymbol({
                style: "diamond",
                color: color,
                size: size,
                outline: { color: [255, 255, 255, 1], width: 2 }
            });

            const graphic = new Graphic({
                geometry: point,
                symbol: symbol,
                attributes: airport,
                popupTemplate: new PopupTemplate({
                    title: `${airport.name} (${airport.ident})`,
                    content: `
                        <div>
                            <p><strong>ç±»å‹:</strong> ${airport.airport_type}</p>
                            <p><strong>åŸå¸‚:</strong> ${airport.municipality}</p>
                            <p><strong>åæ ‡:</strong> ${airport.longitude.toFixed(4)}, ${airport.latitude.toFixed(4)}</p>
                            ${airport.iata_code ? `<p><strong>IATA:</strong> ${airport.iata_code}</p>` : ''}
                            ${airport.elevation_ft ? `<p><strong>æµ·æ‹”:</strong> ${airport.elevation_ft} ft</p>` : ''}
                        </div>
                    `
                })
            });

            airportLayer.add(graphic);
        }

        function addBirdPoint(record) {
            const point = new Point({
                longitude: record.longitude,
                latitude: record.latitude
            });

            let color = [128, 128, 128, 0.8];
            if (record.risk_level === 'high') {
                color = [255, 0, 0, 0.9];
            } else if (record.risk_level === 'medium') {
                color = [255, 255, 0, 0.9];
            } else if (record.risk_level === 'low') {
                color = [0, 255, 0, 0.9];
            }

            const symbol = new SimpleMarkerSymbol({
                style: "circle",
                color: color,
                size: 8, // å‡å°é¸Ÿæƒ…æ ‡è®°å°ºå¯¸ä»¥æé«˜æ€§èƒ½
                outline: { color: [255, 255, 255, 1], width: 1 }
            });

            const graphic = new Graphic({
                geometry: point,
                symbol: symbol,
                attributes: record,
                popupTemplate: new PopupTemplate({
                    title: `${record.species || 'é¸Ÿç±»'} - ${record.risk_level === 'high' ? 'é«˜é£é™©' : record.risk_level === 'medium' ? 'ä¸­é£é™©' : 'ä½é£é™©'}`,
                    content: `
                        <div>
                            <p><strong>ä½ç½®:</strong> ${record.location}</p>
                            <p><strong>æ•°é‡:</strong> ${record.quantity} åª</p>
                            <p><strong>ç»çº¬åº¦:</strong> ${record.longitude.toFixed(4)}, ${record.latitude.toFixed(4)}</p>
                        </div>
                    `
                })
            });

            birdLayer.add(graphic);
        }

        // ä½ç½®ä¿¡æ¯æ›´æ–°
        view.watch(["camera", "center"], function() {
            updateCurrentPosition();
        });

        function updateCurrentPosition() {
            if (!view) return;

            try {
                const camera = view.camera;
                const center = view.center;

                document.getElementById('currentLon').textContent = center ? center.longitude.toFixed(6) : '--';
                document.getElementById('currentLat').textContent = center ? center.latitude.toFixed(6) : '--';
                document.getElementById('currentAlt').textContent = camera ? Math.round(camera.position.z) : '--';
                document.getElementById('currentHeading').textContent = camera ? Math.round(camera.heading) : '--';
                document.getElementById('currentTilt').textContent = camera ? Math.round(camera.tilt) : '--';

                // æŸ¥æ‰¾é™„è¿‘æœºåœº
                if (center && airports.length > 0) {
                    let nearest = null;
                    let minDist = Infinity;

                    airports.forEach(airport => {
                        const dist = Math.sqrt(
                            Math.pow(center.longitude - airport.longitude, 2) +
                            Math.pow(center.latitude - airport.latitude, 2)
                        );
                        if (dist < minDist) {
                            minDist = dist;
                            nearest = airport;
                        }
                    });

                    if (nearest) {
                        document.getElementById('nearestAirport').textContent =
                            `${nearest.name} (${nearest.ident}) - ${(minDist * 111).toFixed(1)}km`;
                    }
                }

                // è®¡ç®—å¯è§é¸Ÿæƒ…è®°å½•
                if (center && birdRecords.length > 0) {
                    const extent = view.extent;
                    let count = 0;

                    if (extent) {
                        birdRecords.forEach(record => {
                            if (record.longitude >= extent.xmin && record.longitude <= extent.xmax &&
                                record.latitude >= extent.ymin && record.latitude <= extent.ymax) {
                                count++;
                            }
                        });
                    }

                    document.getElementById('nearbyBirds').textContent = `${count} æ¡`;
                }

                document.getElementById('currentPosition').querySelector('.text-muted').style.display = 'none';
                document.getElementById('positionDetails').style.display = 'block';

            } catch (error) {
                console.error('ä½ç½®æ›´æ–°é”™è¯¯:', error);
            }
        }

        // è§†å›¾åŠ è½½å®Œæˆ
        view.when(function() {
            console.log("ğŸ‰ ç®€åŒ–ç‰ˆ3Dåœ°å›¾åŠ è½½å®Œæˆï¼");

            // æ·»åŠ æˆåŠŸæç¤º
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 123, 255, 0.95);
                color: white;
                padding: 20px;
                border-radius: 15px;
                z-index: 2000;
                font-size: 18px;
                box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                text-align: center;
                max-width: 400px;
            `;
            successDiv.innerHTML = `
                <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 15px;"></i><br>
                <strong>ç®€åŒ–ç‰ˆ3Dåœ°å›¾åŠ è½½æˆåŠŸï¼</strong><br>
                <small style="opacity: 0.9;">
                    âœ“ è½»é‡çº§å«æ˜Ÿåœ°å›¾<br>
                    âœ“ æœºåœºæ•°æ®æ ‡è®°<br>
                    âœ“ é¸Ÿæƒ…é£é™©æ˜¾ç¤º<br>
                    âœ“ å®æ—¶ä½ç½®ä¿¡æ¯<br>
                    âœ“ æ™ºèƒ½æœç´¢åŠŸèƒ½
                </small>
            `;
            document.getElementById('mapView').appendChild(successDiv);

            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 6000);

        }).catch(function(error) {
            console.error("âŒ åœ°å›¾åŠ è½½å¤±è´¥:", error);

            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(220, 53, 69, 0.95);
                color: white;
                padding: 20px;
                border-radius: 15px;
                text-align: center;
                z-index: 2000;
                max-width: 400px;
                box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            `;
            errorDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i><br>
                <strong>åœ°å›¾åŠ è½½å¤±è´¥</strong><br>
                <small>${error.message}</small><br>
                <small style="opacity: 0.8;">è¯·åˆ·æ–°é¡µé¢é‡è¯•</small>
            `;
            document.getElementById('mapView').appendChild(errorDiv);
        });

    } catch (e) {
        console.error("âŒ åˆ›å»ºåœ°å›¾æ—¶å‡ºé”™:", e);

        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(220, 53, 69, 0.95);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            z-index: 2000;
            max-width: 400px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        `;
        errorDiv.innerHTML = `
            <i class="fas fa-times-circle" style="font-size: 48px; margin-bottom: 15px;"></i><br>
            <strong>åœ°å›¾åˆ›å»ºå¤±è´¥</strong><br>
            <small>${e.message}</small>
        `;
        document.getElementById('mapView').appendChild(errorDiv);
    }

});

// ==================== è§†å›¾æ§åˆ¶ ====================
function resetView() {
    if (view) {
        view.goTo({
            camera: {
                position: [117.346000671, 39.1244010925, 1000],
                heading: 0,
                tilt: 15
            }
        });
        console.log('è§†å›¾å·²é‡ç½®åˆ°å¤©æ´¥æœºåœº');
    }
}

    // å®šä¹‰å…¨å±€å‡½æ•°

function updateAirportMenuActive(activeSource) {
    // æ›´æ–°ä¸‹æ‹‰èœå•ä¸­çš„æ¿€æ´»çŠ¶æ€
    const menuItems = document.querySelectorAll('.dropdown-menu .dropdown-item');
    menuItems.forEach(item => {
        item.classList.remove('active');
        const checkIcon = item.querySelector('.fa-check');
        if (checkIcon) {
            checkIcon.remove();
        }
    });

    // æ‰¾åˆ°å¯¹åº”çš„èœå•é¡¹å¹¶æ¿€æ´»
    const activeItem = document.querySelector(`.dropdown-menu .dropdown-item[onclick*="${activeSource}"]`);
    if (activeItem) {
        activeItem.classList.add('active');
        // æ·»åŠ é€‰ä¸­å›¾æ ‡
        const iconHtml = '<i class="fas fa-check text-success me-2"></i>';
        activeItem.innerHTML = iconHtml + activeItem.textContent.replace('âœ“', '').trim();
    }
}

// ==================== é¢æ¿æ‹–æ‹½å’ŒæŠ˜å åŠŸèƒ½ ====================

// æœç´¢é¢æ¿æ‹–æ‹½
let searchPanelDrag = false;
let searchPanelOffsetX = 0;
let searchPanelOffsetY = 0;

document.getElementById('searchPanel').addEventListener('mousedown', function(e) {
    // åªæœ‰åœ¨é¢æ¿æ ‡é¢˜æ ä¸Šæ‰èƒ½æ‹–æ‹½ï¼Œé¿å…å½±å“è¾“å…¥æ¡†
    if (e.target.closest('.card-header') && !e.target.closest('button')) {
        searchPanelDrag = true;
        const rect = this.getBoundingClientRect();
        searchPanelOffsetX = e.clientX - rect.left;
        searchPanelOffsetY = e.clientY - rect.top;

        this.style.cursor = 'grabbing';
        e.preventDefault();
    }
});

document.addEventListener('mousemove', function(e) {
    if (searchPanelDrag) {
        const panel = document.getElementById('searchPanel');
        const newLeft = e.clientX - searchPanelOffsetX;
        const newTop = e.clientY - searchPanelOffsetY;

        const maxLeft = window.innerWidth - panel.offsetWidth - 10;
        const maxTop = window.innerHeight - panel.offsetHeight - 10;

        panel.style.left = Math.max(10, Math.min(newLeft, maxLeft)) + 'px';
        panel.style.top = Math.max(10, Math.min(newTop, maxTop)) + 'px';
    }
});

document.addEventListener('mouseup', function() {
    searchPanelDrag = false;
    document.getElementById('searchPanel').style.cursor = 'move';
});

// ä½ç½®é¢æ¿æ‹–æ‹½
let positionPanelDrag = false;
let positionPanelOffsetX = 0;
let positionPanelOffsetY = 0;

document.getElementById('positionPanel').addEventListener('mousedown', function(e) {
    // åªæœ‰åœ¨é¢æ¿æ ‡é¢˜æ ä¸Šæ‰èƒ½æ‹–æ‹½ï¼Œé¿å…å½±å“æ˜¾ç¤ºå†…å®¹
    if (e.target.closest('.card-header') && !e.target.closest('button')) {
        positionPanelDrag = true;
        const rect = this.getBoundingClientRect();
        positionPanelOffsetX = e.clientX - rect.left;
        positionPanelOffsetY = e.clientY - rect.top;

        this.style.cursor = 'grabbing';
        e.preventDefault();
    }
});

document.addEventListener('mousemove', function(e) {
    if (positionPanelDrag) {
        const panel = document.getElementById('positionPanel');
        const newLeft = e.clientX - positionPanelOffsetX;
        const newTop = e.clientY - positionPanelOffsetY;

        const maxLeft = window.innerWidth - panel.offsetWidth - 10;
        const maxTop = window.innerHeight - panel.offsetHeight - 10;

        panel.style.left = Math.max(10, Math.min(newLeft, maxLeft)) + 'px';
        panel.style.top = Math.max(10, Math.min(newTop, maxTop)) + 'px';
    }
});

document.addEventListener('mouseup', function() {
    positionPanelDrag = false;
    document.getElementById('positionPanel').style.cursor = 'move';
});

// é¢æ¿æŠ˜å /å±•å¼€åŠŸèƒ½
function toggleSearchPanel() {
    const body = document.getElementById('searchPanelBody');
    const icon = document.getElementById('searchToggleIcon');

    if (body.style.display === 'none') {
        body.style.display = 'block';
        icon.className = 'fas fa-chevron-up';
    } else {
        body.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
    }
}

function togglePositionPanel() {
    const body = document.getElementById('positionPanelBody');
    const icon = document.getElementById('positionToggleIcon');

    if (body.style.display === 'none') {
        body.style.display = 'block';
        icon.className = 'fas fa-chevron-up';
    } else {
        body.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
    }
}

// å…³é—­é¢æ¿åŠŸèƒ½
function closeSearchPanel() {
    const panel = document.getElementById('searchPanel');
    panel.style.display = 'none';

    if (!document.getElementById('showSearchPanelBtn')) {
        const btn = document.createElement('button');
        btn.id = 'showSearchPanelBtn';
        btn.className = 'btn btn-primary btn-sm position-absolute';
        btn.style.cssText = 'top: 20px; left: 20px; z-index: 999;';
        btn.innerHTML = '<i class="fas fa-search"></i> æœç´¢';
        btn.onclick = function() {
            panel.style.display = 'block';
            this.remove();
        };
        document.getElementById('mapView').parentNode.appendChild(btn);
    }
}

function closePositionPanel() {
    const panel = document.getElementById('positionPanel');
    panel.style.display = 'none';

    if (!document.getElementById('showPositionPanelBtn')) {
        const btn = document.createElement('button');
        btn.id = 'showPositionPanelBtn';
        btn.className = 'btn btn-info btn-sm position-absolute';
        btn.style.cssText = 'top: 20px; right: 20px; z-index: 999;';
        btn.innerHTML = '<i class="fas fa-location-arrow"></i> ä½ç½®';
        btn.onclick = function() {
            panel.style.display = 'block';
            this.remove();
        };
        document.getElementById('mapView').parentNode.appendChild(btn);
    }
}

// ==================== æœç´¢åŠŸèƒ½ ====================
function gotoCoordinates() {
    const coordText = document.getElementById('coordInput').value.trim();
    if (!coordText) {
        alert('è¯·è¾“å…¥åæ ‡ï¼');
        return;
    }

    const coords = coordText.split(',');
    if (coords.length !== 2) {
        alert('æ ¼å¼é”™è¯¯ï¼è¯·ä½¿ç”¨ "ç»åº¦,çº¬åº¦" æ ¼å¼ã€‚');
        return;
    }

    const lon = parseFloat(coords[0].trim());
    const lat = parseFloat(coords[1].trim());

    if (isNaN(lon) || isNaN(lat)) {
        alert('åæ ‡å€¼æ— æ•ˆï¼');
        return;
    }

    if (view) {
        view.goTo({
            center: [lon, lat],
            zoom: 12
        });
        console.log(`ğŸ“ è·³è½¬åˆ°åæ ‡: ${lon}, ${lat}`);
    }
}

function searchAirport() {
    const searchText = document.getElementById('airportSearch').value.trim().toLowerCase();
    if (!searchText) {
        alert('è¯·è¾“å…¥æœºåœºåç§°æˆ–ä»£ç ï¼');
        return;
    }

    if (airports.length === 0) {
        alert('æœºåœºæ•°æ®è¿˜æœªåŠ è½½å®Œæˆ');
        return;
    }

    const matches = airports.filter(airport =>
        airport.ident.toLowerCase().includes(searchText) ||
        airport.name.toLowerCase().includes(searchText) ||
        (airport.iata_code && airport.iata_code.toLowerCase().includes(searchText))
    );

    if (matches.length === 0) {
        alert('æœªæ‰¾åˆ°åŒ¹é…çš„æœºåœºï¼');
        return;
    }

    if (matches.length === 1) {
        const airport = matches[0];
        if (view) {
            view.goTo({
                center: [airport.longitude, airport.latitude],
                zoom: 14
            });
        }
        return;
    }

    // æ˜¾ç¤ºæœç´¢ç»“æœ
    const resultsDiv = document.getElementById('searchResults');
    const resultsContent = document.getElementById('searchResultsContent');

    let html = '<div class="small">';
    matches.slice(0, 5).forEach(airport => {
        html += `<div class="p-1 border-bottom" style="cursor: pointer;" onclick="gotoAirport(${airport.longitude}, ${airport.latitude}, '${airport.name}')">`;
        html += `<strong>${airport.name}</strong> (${airport.ident})`;
        if (airport.iata_code) html += ` - ${airport.iata_code}`;
        html += `<br><small class="text-muted">${airport.municipality}</small>`;
        html += '</div>';
    });
    html += '</div>';

    resultsContent.innerHTML = html;
    resultsDiv.style.display = 'block';
}

function gotoAirport(lon, lat, name) {
    if (view) {
        view.goTo({
            center: [lon, lat],
            zoom: 14
        });
        console.log(`âœˆï¸ è·³è½¬åˆ°æœºåœº: ${name}`);
        document.getElementById('searchResults').style.display = 'none';
    }
}

// ç»‘å®šå›è½¦é”®
document.getElementById('coordInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') gotoCoordinates();
});

document.getElementById('airportSearch').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') searchAirport();
});

// ==================== ä¼˜åŒ–ç¼©æ”¾åŠŸèƒ½ ====================
document.addEventListener('wheel', function(e) {
    const mapView = document.getElementById('mapView');
    const rect = mapView.getBoundingClientRect();
    const isInMap = (e.clientX >= rect.left && e.clientX <= rect.right &&
                     e.clientY >= rect.top && e.clientY <= rect.bottom);

    if (isInMap) {
        return; // åœ¨åœ°å›¾å†…å…è®¸ç¼©æ”¾
    } else if (e.ctrlKey) {
        e.preventDefault(); // åœ¨åœ°å›¾å¤–é˜»æ­¢é¡µé¢ç¼©æ”¾
        return false;
    }
}, { passive: false });
</script>

{% endblock %}
